https://medium.com/codex/mastering-error-handling-in-ruby-on-rails-best-practices-tips-and-tricks-%EF%B8%8F-03f6c9216667

Освоение обработки ошибок в Ruby on Rails: лучшие практики, советы и рекомендации

```с помощью репортера
class CheckoutsController < ApplicationController
	def create
		#...
		rescue CheckoutServise::FraudDetected => e
			#...
			report_error(e)
			render(
				json: {error: "Fraud Detected", e.class.name },
				status: bed_request
			)
		end
	end
end
```

Понимание обработки ошибок в Rails
Обработка ошибок — это процесс реагирования на ошибочные состояния в вашем приложении и восстановления после них. В Rails ошибки могут возникать по разным причинам, таким как неверный пользовательский ввод, проблемы с базой данных или неожиданное поведение в вашем коде. Правильная обработка ошибок гарантирует, что ваше приложение сможет корректно обрабатывать эти ситуации без сбоев.
---------------------------------------------------------------------
Типы ошибок в Rails
a. Синтаксические ошибки
Они возникают, когда в синтаксисе кода есть ошибка. Rails обычно обнаруживает их на этапе разработки.

b. Ошибки времени выполнения
Они возникают во время выполнения программы. Распространенные примеры включают NoMethodError, ArgumentError и TypeError.

c. Логические ошибки
Это ошибки в логике вашего кода, которые приводят к неверным результатам. Их может быть сложно отладить, поскольку код выполняется без возникновения исключений.

d. Ошибки базы данных
Они возникают, когда возникает проблема с операциями базы данных, такими как ActiveRecord::RecordNotFound или ActiveRecord::RecordInvalid.

e. Ошибки HTTP
Они связаны с веб-запросами, такими как 404 Not Found или 500 Internal Server Error.
---------------------------------------------------------------------
Стандартные методы обработки ошибок
a. Begin-Rescue-End Bloc
Наиболее распространенный способ обработки ошибок в Ruby — использование блока begin-rescue-end. Это позволяет перехватывать исключения и обрабатывать их изящно.
```
begin
  # Code that might raise an exception
  user = User.find(params[:id])
rescue ActiveRecord::RecordNotFound => e
  # Handle the exception
  flash[:error] = "User not found"
  redirect_to root_path
end
```

b. Rescue From in Controllers
Rails предоставляет удобный способ обработки исключений на уровне контроллера с помощью rescue_from.
```
class ApplicationController < ActionController::Base
  rescue_from ActiveRecord::RecordNotFound, with: :record_not_found

  private
  def record_not_found
    flash[:error] = "Record not found"
    redirect_to root_path
  end
end
```

c. Validations
Проверки ActiveRecord помогают предотвратить ошибки, гарантируя целостность данных перед сохранением в базе данных.
```
class User < ApplicationRecord
  validates :email, presence: true, uniqueness: true
end
```

d. Custom Exceptions
Вы можете определить пользовательские исключения для обработки определенных состояний ошибок в вашем приложении.
```
class CustomError < StandardError; end

begin
  raise CustomError, "Something went wrong"
rescue CustomError => e
  puts e.message
end
```

---------------------------------------------------------------------
Пользовательская обработка ошибок

a. Custom Error Pages
Rails позволяет вам создавать пользовательские страницы ошибок для различных кодов статуса HTTP. Поместите эти файлы в общедоступный каталог или обрабатывайте их динамически в ваших контроллерах.
```config/application.rb
config.exceptions_app = self.routes
```

b. Logging Errors
Ведение журнала необходимо для отладки и мониторинга. Rails предоставляет встроенный регистратор, который можно использовать для ведения журнала ошибок.
```
begin
  # Risky code
rescue => e
  Rails.logger.error "Error occurred: #{e.message}"
  raise
end
```

c. Sending Notifications
Вы можете использовать такие инструменты, как Airbrake или Sentry, для отправки уведомлений об ошибках своей команде.
```
begin
  # Risky code
rescue => e
  Airbrake.notify(e)
  raise
end
```
---------------------------------------------------------------------
Лучшие методы обработки ошибок
a. Fail Fast
Выявляйте и обрабатывайте ошибки как можно раньше. Это упрощает отладку и предотвращает каскадные сбои.

b. Будьте конкретны с _Rescue
Избегайте восстановления общих исключений, таких как StandardError. Вместо этого, спасайте определенные исключения, чтобы не маскировать другие проблемы.

c. Используйте транзакции для операций с базой данных
Оберните операции с базой данных в транзакции, чтобы обеспечить согласованность данных в случае ошибок.
```
ActiveRecord::Base.transaction do
  # Database operations
end
```
d. Тестируйте обработку ошибок
Напишите тесты, чтобы убедиться, что логика обработки ошибок работает так, как ожидается. Используйте такие инструменты, как RSpec или Minitest.

e. Сохраняйте общие сообщения для пользователей
Избегайте раскрытия конфиденциальной информации в сообщениях об ошибках, отображаемых пользователям. Вместо этого регистрируйте подробные ошибки внутри.

---------------------------------------------------------------------
Советы и рекомендации
а. Используйте rescue с модификаторами
Вы можете использовать rescue как модификатор для краткой обработки ошибок.
```
user = User.find(params[:id]) rescue nil
```

б. Используйте блок ensure для очистки
Используйте блок ensure для выполнения кода, который должен работать независимо от того, было ли вызвано исключение.
```
begin
  # Risky code
rescue => e
  # Handle error
ensure
  # Cleanup code
end
```

c. Monitor Production Errors
Используйте инструменты отслеживания ошибок, такие как Sentry, Rollbar или Honeybadger, для мониторинга ошибок в производстве.

г. Используйте throw и catch для управления потоком
Хотя throw и catch используются нечасто, они могут быть полезны для нелокальных выходов в вашем коде.
```
catch(:done) do
  # Code that can throw :done
end
```

